const fs = require("fs");
const path = require("path");
const { execSync } = require("child_process");

const ROOT = process.cwd();

// Color helpers
const colors = {
    reset: "\x1b[0m",
    cyan: "\x1b[36m",
    yellow: "\x1b[33m",
    green: "\x1b[32m",
    red: "\x1b[31m",
    gray: "\x1b[90m",
    purple: "\x1b[35m"
};

const logArray = [];

function log(msg, color = colors.reset) {
    const message = color + msg + colors.reset;
    console.log(colors.reset); // maintain spacing
    logArray.push(message);
}

function run(cmd) {
    execSync(cmd, { stdio: "inherit" });
}

const steps = [
    "Checking build directory",
    "Removing build directory",
    "Checking smol-toml patch",
    "Patching smol-toml",
    "Setting NODE_ENV",
    "Compiling TypeScript",
    "Running tsc-alias",
    "Checking .env",
    "Copying .env",
    "Build complete",
    "Done",
    "Done"
];

let currentStep = 0;

function renderProgressBar() {
    // Clear previous lines if not first step
    if (currentStep !== 0) {
        process.stdout.write("\x1b[1A\x1b[2K".repeat(4));
    } else {
        process.stdout.write("\n\n");
    }

    const width = 40;
    const progress = Math.min(currentStep / (steps.length - 1), 1);
    const filled = Math.round(progress * width);
    const empty = width - filled;

    if (progress === 0) return;

    // Print previous step as completed
    if (logArray[currentStep - 2]) {
        process.stdout.write(`${colors.green}✔${colors.reset} ${logArray[currentStep - 2]}\n`);
    }

    // Build bar
    const bar = `${colors.green}${"▔".repeat(filled)}${colors.gray}${"▔".repeat(empty)}${colors.reset}`;

    // Print current step with progress
    process.stdout.write(
        `\n${colors.green}█${colors.yellow} ${Math.round(progress * 100)}% ${colors.gray}-${colors.reset} ${logArray[currentStep - 1]}\n`
    );
    process.stdout.write(`${bar}\n`);
}

function nextStep() {
    if (currentStep < steps.length - 1) currentStep++;
    renderProgressBar();
}

// INITIAL DISPLAY
process.stdout.write("\n");
log("Checking for existing build directory...", colors.yellow);
renderProgressBar();

// STEP 1
nextStep();

const buildPath = path.join(ROOT, "build");
let removed = false;

if (fs.existsSync(buildPath)) {
    log("Removing existing build directory...", colors.cyan);
    fs.rmSync(buildPath, { recursive: true, force: true });
    removed = true;
}
nextStep();

// STEP 3
log("Checking if smol-toml error.d.ts exists...", colors.yellow);
const smolErr = path.join(ROOT, "node_modules", "smol-toml", "dist", "error.d.ts");
nextStep();

// STEP 4
if (fs.existsSync(smolErr)) {
    log("Patching smol-toml error.d.ts...", colors.cyan);
    let content = fs.readFileSync(smolErr, "utf-8");
    content = content.replace("type TomlErrorOptions = ErrorOptions & {", "type TomlErrorOptions = {");
    fs.writeFileSync(smolErr, content, "utf-8");
} else {
    log("smol-toml error.d.ts not found. Skipping patch...", colors.yellow);
}
nextStep();

// STEP 5
log("Setting NODE_ENV to production...", colors.cyan);
process.env.NODE_ENV = "production";
nextStep();

// STEP 6
log("Compiling TypeScript files...", colors.cyan);
run("tsc -p .");
nextStep();

// STEP 7
log("Running tsc-alias...", colors.cyan);
run("tsc-alias");
nextStep();

// STEP 8
log("Checking for .env file...", colors.yellow);
const envPath = path.join(ROOT, ".env");
const outEnv = path.join(buildPath, ".env");
nextStep();

// STEP 9
if (fs.existsSync(envPath)) {
    log("Copying environment variables...", colors.cyan);
    fs.copyFileSync(envPath, outEnv);
} else {
    log("No .env file found. Skipping...", colors.yellow);
}
nextStep();

// STEP 10 — COMPLETE
log("Build completed successfully.", colors.green);
nextStep();

// Clean up final line
log("Build completed successfully.", colors.green);
nextStep();
process.stdout.write("\x1b[2K\x1b[1A");
process.stdout.write("\x1b[2K\x1b[1A");
